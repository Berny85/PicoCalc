{% extends "base.html" %}

{% block title %}{{ title }} - Picobellu Kalkulator{% endblock %}

{% block content %}
<div class="card">
    <h2>{{ title }}</h2>
    
    <form method="POST" action="{% if machine %}/machines/{{ machine.id }}/update{% else %}/machines{% endif %}">
        <div class="grid">
            <div>
                <div class="form-group">
                    <label for="name">Maschinenname *</label>
                    <input type="text" id="name" name="name" required 
                           value="{{ machine.name if machine else '' }}"
                           placeholder="z.B. Prusa i3 MK3, Silhouette Cameo">
                </div>
                
                <div class="form-group">
                    <label for="machine_type">Typ *</label>
                    <select id="machine_type" name="machine_type" required onchange="updateFormFields()">
                        <option value="3d_printer" {% if machine and machine.machine_type == '3d_printer' %}selected{% endif %}>
                            3D-Drucker
                        </option>
                        <option value="cutter_plotter" {% if machine and machine.machine_type == 'cutter_plotter' %}selected{% endif %}>
                            Schneideplotter
                        </option>
                        <option value="inkjet_printer" {% if machine and machine.machine_type == 'inkjet_printer' %}selected{% endif %}>
                            Tintenstrahl-Drucker
                        </option>
                        <option value="other" {% if machine and machine.machine_type == 'other' %}selected{% endif %}>
                            Sonstiges
                        </option>
                    </select>
                </div>
            </div>
            
            <div>
                <div class="form-group">
                    <label for="description">Beschreibung</label>
                    <textarea id="description" name="description">{{ machine.description if machine else '' }}</textarea>
                </div>
            </div>
        </div>
        
        <h3 style="margin-top: 30px; color: var(--color-primary-dark);">Kosten-Parameter</h3>
        
        <!-- Zeitbasierte Felder (für 3D-Drucker, Cutter, etc.) -->
        <div id="time-based-fields" class="grid">
            <div>
                <div class="form-group">
                    <label for="depreciation_euro">Abschreibung (€)</label>
                    <input type="number" id="depreciation_euro" name="depreciation_euro" 
                           step="0.01" min="0"
                           value="{{ machine.depreciation_euro if machine else '350' }}">
                </div>
                
                <div class="form-group">
                    <label for="lifespan_hours">Lebensdauer (Stunden)</label>
                    <input type="number" id="lifespan_hours" name="lifespan_hours" 
                           step="1" min="1"
                           value="{{ machine.lifespan_hours if machine else '3000' }}">
                </div>
            </div>
            
            <div>
                <div class="form-group">
                    <label for="power_kw">Stromverbrauch (kW)</label>
                    <input type="number" id="power_kw" name="power_kw" 
                           step="0.001" min="0"
                           value="{{ machine.power_kw if machine else '0,1' }}">
                    <small style="color: var(--color-text-light);">z.B. 0,1 für 100W</small>
                </div>
                
                <div class="form-group">
                    <label>Berechnete Kosten pro Stunde</label>
                    <div id="calculated-cost-hourly" style="padding: 10px; background: var(--color-bg-hover); border-radius: 4px;">
                        <strong>{% if machine %}{{ "%.4f"|format(machine.calculate_cost_per_hour()) }} €{% else %}- €{% endif %}</strong>
                        {% if machine %}
                        {% set power_kw_float = machine.power_kw | float %}
                        {% set depreciation_float = machine.depreciation_euro | float %}
                        {% set lifespan_float = machine.lifespan_hours | float %}
                        <small style="color: var(--color-text-light); display: block; margin-top: 5px;">
                            (Strom: {{ "%.3f"|format(STROM_PREIS_KWH * power_kw_float) }} €/h + Abschreibung: {{ "%.3f"|format(depreciation_float/lifespan_float) }} €/h)
                        </small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Seitenbasierte Felder (nur für Tintenstrahl-Drucker) -->
        <div id="page-based-fields" class="grid" style="display: none;">
            <div>
                <div class="form-group">
                    <label for="lifespan_pages">Lebensdauer (Seiten)</label>
                    <input type="number" id="lifespan_pages" name="lifespan_pages" 
                           step="1" min="0"
                           value="{{ machine.lifespan_pages|int if machine and machine.lifespan_pages else '' }}">
                    <small style="color: var(--color-text-light);">Erwartete Gesamtdruckmenge in Seiten</small>
                </div>
            </div>
            
            <div>
                <div class="form-group">
                    <label for="depreciation_per_page">Abschreibung pro Seite (€)</label>
                    <input type="number" id="depreciation_per_page" name="depreciation_per_page" 
                           step="0.0001" min="0"
                           value="{{ machine.depreciation_per_page if machine and machine.depreciation_per_page else '' }}">
                    <small style="color: var(--color-text-light);">Z.B. 0,05 für 5 Cent pro Seite</small>
                </div>
                
                <div class="form-group">
                    <label>Berechnete Kosten pro Seite</label>
                    <div id="calculated-cost-page" style="padding: 10px; background: var(--color-bg-hover); border-radius: 4px;">
                        <strong>{% if machine and machine.machine_type == 'inkjet_printer' %}{{ "%.4f"|format(machine.calculate_cost_per_page()) }} €{% else %}- €{% endif %}</strong>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="actions">
            <button type="submit" class="btn btn-primary">
                {% if machine %}Aktualisieren{% else %}Maschine speichern{% endif %}
            </button>
            <a href="/machines" class="btn btn-secondary">Abbrechen</a>
        </div>
    </form>
</div>

<script>
const STROM_PREIS_KWH = {{ STROM_PREIS_KWH }};
const depreciationInput = document.getElementById('depreciation_euro');
const lifespanInput = document.getElementById('lifespan_hours');
const powerKwInput = document.getElementById('power_kw');
const machineTypeSelect = document.getElementById('machine_type');
const timeBasedFields = document.getElementById('time-based-fields');
const pageBasedFields = document.getElementById('page-based-fields');
const lifespanPagesInput = document.getElementById('lifespan_pages');
const depreciationPerPageInput = document.getElementById('depreciation_per_page');

function updateFormFields() {
    const selectedType = machineTypeSelect.value;
    
    if (selectedType === 'inkjet_printer') {
        // Zeige seitenbasierte Felder, verstecke zeitbasierte
        timeBasedFields.style.display = 'none';
        pageBasedFields.style.display = 'grid';
        
        // Mache zeitbasierte Felder optional
        depreciationInput.required = false;
        lifespanInput.required = false;
        powerKwInput.required = false;
    } else {
        // Zeige zeitbasierte Felder, verstecke seitenbasierte
        timeBasedFields.style.display = 'grid';
        pageBasedFields.style.display = 'none';
        
        // Mache zeitbasierte Felder required
        depreciationInput.required = true;
        lifespanInput.required = true;
        powerKwInput.required = true;
    }
}

function updateCalculatedCostHourly() {
    const depreciation = parseFloat(depreciationInput.value) || 0;
    const lifespan = parseFloat(lifespanInput.value) || 1;
    const power = parseFloat(powerKwInput.value) || 0;
    
    const stromKosten = STROM_PREIS_KWH * power;
    const abschreibung = depreciation / lifespan;
    const costPerHour = stromKosten + abschreibung;
    
    const costElement = document.getElementById('calculated-cost-hourly');
    costElement.innerHTML = '<strong>' + costPerHour.toFixed(4) + ' €</strong>';
    costElement.innerHTML += '<small style="color: var(--color-text-light); display: block; margin-top: 5px;">';
    costElement.innerHTML += '(Strom: ' + stromKosten.toFixed(3) + ' €/h + Abschreibung: ' + abschreibung.toFixed(3) + ' €/h)';
    costElement.innerHTML += '</small>';
}

function updateCalculatedCostPerPage() {
    const costPerPage = parseFloat(depreciationPerPageInput.value) || 0;
    
    const costElement = document.getElementById('calculated-cost-page');
    costElement.innerHTML = '<strong>' + costPerPage.toFixed(4) + ' €</strong>';
}

// Event Listener
depreciationInput.addEventListener('input', updateCalculatedCostHourly);
lifespanInput.addEventListener('input', updateCalculatedCostHourly);
powerKwInput.addEventListener('input', updateCalculatedCostHourly);
depreciationPerPageInput.addEventListener('input', updateCalculatedCostPerPage);

// Initialisierung
updateFormFields();
</script>
{% endblock %}
