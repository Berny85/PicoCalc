{% extends "base.html" %}

{% block title %}{{ title }} - Picobellu Kalkulator{% endblock %}

{% block content %}
<div class="card">
    <h2>{{ title }}</h2>
    
    <form method="POST" action="{% if product %}/products/{{ product.id }}/update{% else %}/products/sticker-sheet{% endif %}">
        <div class="grid">
            <div>
                <div class="form-group">
                    <label for="name">Produktname *</label>
                    <input type="text" id="name" name="name" required 
                           value="{{ product.name if product else '' }}">
                </div>
                
                <!-- Kategorie ausgeblendet - wird automatisch auf "Sonstiges" gesetzt -->
                <input type="hidden" name="category" value="Sonstiges">
            </div>
            
            <div>
                <div class="form-group">
                    <label for="sheet_material_id">Material (Papier) *</label>
                    <select id="sheet_material_id" name="sheet_material_id" required>
                        <option value="">-- Bitte w√§hlen --</option>
                        {% for s in sticker_sheets %}
                        <option value="{{ s.id }}" 
                                {% if product and product.sheet_material_id == s.id %}selected{% endif %}>
                            {{ s.name }} {% if s.brand %}({{ s.brand }}){% endif %} - {{ s.price_per_unit }}‚Ç¨/{{ s.unit }}
                        </option>
                        {% endfor %}
                    </select>
                    <small style="color: var(--color-text-light);">
                        <a href="/materials/new" target="_blank">Neues Material anlegen ‚Üí</a>
                    </small>
                </div>
                
                <!-- Anzahl B√∂gen ist immer 1 -->
                <input type="hidden" name="sheet_count" value="1">
            </div>
        </div>
        
        <h3 style="margin-top: 30px; color: var(--color-primary-dark);">Berechnungsmodus</h3>
        <div class="grid">
            <div>
                <div class="form-group">
                    <label for="calculation_mode">Kalkulationsmethode *</label>
                    <select id="calculation_mode" name="calculation_mode" required onchange="updateCalculationFields()">
                        <option value="per_unit" {% if product and product.calculation_mode == 'per_unit' %}selected{% endif %}>
                            Pro Einheit (Standard)
                        </option>
                        <option value="per_batch" {% if product and product.calculation_mode == 'per_batch' %}selected{% endif %}>
                            Pro Batch (f√ºr Mehrfach-Produktion)
                        </option>
                    </select>
                    <small style="color: var(--color-text-light);">
                        <strong>Pro Einheit:</strong> Kosten gelten f√ºr 1 Sticker-Sheet<br>
                        <strong>Pro Batch:</strong> Kosten werden auf mehrere Einheiten verteilt
                    </small>
                </div>
            </div>
            
            <div>
                <div class="form-group" id="units_per_sheet_group">
                    <label for="units_per_sheet">Produkteinheiten *</label>
                    <input type="number" id="units_per_sheet" name="units_per_sheet" 
                           step="1" min="1" required
                           value="{{ product.units_per_sheet if product else '3' }}"
                           placeholder="z.B. 3">
                    <small style="color: var(--color-text-light);">
                        Wie viele Sticker-Sheets kommen aus einem Materialbogen?
                    </small>
                </div>
                
                <div class="form-group" id="units_per_batch_group" style="display: none;">
                    <label for="units_per_batch">Einheiten pro Batch *</label>
                    <input type="number" id="units_per_batch" name="units_per_batch" 
                           step="1" min="1"
                           value="{{ product.units_per_batch if product else '3' }}"
                           placeholder="z.B. 3">
                    <small style="color: var(--color-text-light);">
                        Wie viele Sticker-Sheets werden in einem Durchgang produziert?
                    </small>
                </div>
            </div>
        </div>
        
        <h3 style="margin-top: 30px; color: var(--color-primary-dark);">Maschinen</h3>
        <div id="machines-container">
            <!-- Maschinen werden hier dynamisch hinzugef√ºgt -->
        </div>
        
        <div style="margin-top: 15px;">
            <button type="button" class="btn btn-secondary" onclick="addMachineRow()">
                ‚ûï Maschine hinzuf√ºgen
            </button>
            <small style="color: var(--color-text-light); margin-left: 10px;">
                z.B. Drucker und Plotter
            </small>
        </div>
        
        <h3 style="margin-top: 30px; color: var(--color-primary-dark);">Produktion</h3>
        <div class="grid">
            <div>
                <div class="form-group">
                    <label for="labor_minutes">Arbeitszeit (Minuten)</label>
                    <input type="text" id="labor_minutes" name="labor_minutes" 
                           pattern="[0-9]*[.,]?[0-9]*" inputmode="decimal"
                           value="{% if product %}{{ product.labor_minutes }}{% else %}0{% endif %}">
                    <small style="color: var(--color-text-light);">Produktionszeit in Minuten</small>
                </div>
                
                <div class="form-group">
                    <label for="labor_rate_per_hour">Stundensatz (‚Ç¨/h)</label>
                    <input type="number" id="labor_rate_per_hour" name="labor_rate_per_hour" 
                           step="0.01" min="0"
                           value="{{ product.labor_rate_per_hour if product else '20.00' }}">
                </div>
            </div>
        </div>
        
        <!-- Verpackung und Versand entfernt - wird beim Verkauf erfasst -->
        
        <div class="form-group" style="margin-top: 20px;">
            <label for="notes">Notizen</label>
            <textarea id="notes" name="notes">{{ product.notes if product else '' }}</textarea>
        </div>
        
        <!-- GESAMTKOSTEN (EINKAUFSPREIS) -->
        <div class="card" style="margin-top: 30px; background: var(--color-bg-hover); border: 2px solid var(--color-primary);">
            <h3 style="color: var(--color-primary-dark);">üí∞ Gesamtkosten (Selbstkosten)</h3>
            
            <div class="grid">
                <div>
                    <div class="form-group">
                        <label>Materialkosten</label>
                        <div id="cost-material" style="padding: 10px; background: white; border-radius: 4px; font-size: 1.1rem;">
                            0.00 ‚Ç¨
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Maschinenkosten</label>
                        <div id="cost-machines" style="padding: 10px; background: white; border-radius: 4px; font-size: 1.1rem;">
                            0.00 ‚Ç¨
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Arbeitskosten</label>
                        <div id="cost-labor" style="padding: 10px; background: white; border-radius: 4px; font-size: 1.1rem;">
                            0.00 ‚Ç¨
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; flex-direction: column; justify-content: center;">
                    <div class="form-group" style="text-align: center;">
                        <label style="color: var(--color-primary-dark); font-size: 1.2rem;">GESAMT (Einkaufspreis)</label>
                        <div id="cost-total" style="padding: 20px; background: white; border-radius: 8px; font-size: 2rem; font-weight: bold; border: 3px solid var(--color-primary); color: var(--color-primary-dark);">
                            0.00 ‚Ç¨
                        </div>
                        <small style="color: var(--color-text-light); margin-top: 10px; display: block;">
                            Kosten pro Sticker-Sheet
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="actions">
            <button type="submit" class="btn btn-primary">
                {% if product %}Aktualisieren{% else %}Sticker-Sheet anlegen{% endif %}
            </button>
            <a href="{% if product %}/products/{{ product.id }}{% else %}/products{% endif %}" 
               class="btn btn-secondary">Abbrechen</a>
        </div>
    </form>
</div>

<!-- Template f√ºr Maschinenzeile -->
<template id="machine-row-template">
    <div class="machine-row" style="border: 1px solid var(--color-border); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <strong>Maschine <span class="machine-number">1</span></strong>
            <button type="button" class="btn btn-danger" style="padding: 4px 8px; font-size: 0.75rem;" onclick="removeMachineRow(this)">
                üóëÔ∏è Entfernen
            </button>
        </div>
        <div class="grid">
            <div>
                <div class="form-group">
                    <label>Maschine ausw√§hlen</label>
                    <select name="machine_ids[]" class="machine-select" onchange="updateMachineInfo(this)">
                        <option value="">-- Bitte w√§hlen --</option>
                        {% for m in machines %}
                        <option value="{{ m.id }}" 
                                data-cost-sheet="{{ m.cost_per_sheet or 'null' }}"
                                data-cost-page="{{ m.depreciation_per_page or 'null' }}"
                                data-cost-hour="{{ m.calculate_cost_per_hour() }}">
                            {{ m.name }} 
                            {% if m.cost_per_sheet %}(Bogen: {{ m.cost_per_sheet }}‚Ç¨){% endif %}
                            {% if m.machine_type == 'inkjet_printer' %}(Seite: {{ m.depreciation_per_page or '-' }}‚Ç¨){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div>
                <div class="form-group">
                    <label>Kosten pro Einheit</label>
                    <div class="machine-cost-info" style="padding: 10px; background: var(--color-bg-hover); border-radius: 4px; color: var(--color-text-light);">
                        Bitte Maschine ausw√§hlen
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
let machineCounter = 0;

function addMachineRow() {
    const template = document.getElementById('machine-row-template');
    const container = document.getElementById('machines-container');
    const clone = template.content.cloneNode(true);
    
    machineCounter++;
    clone.querySelector('.machine-number').textContent = machineCounter;
    
    container.appendChild(clone);
    
    // Event Listener f√ºr neue Maschinen-Selects
    const newSelect = container.lastElementChild.querySelector('.machine-select');
    newSelect.addEventListener('change', calculateCosts);
}

function removeMachineRow(button) {
    const row = button.closest('.machine-row');
    row.remove();
    
    // Nummern neu zuweisen
    const rows = document.querySelectorAll('.machine-row');
    rows.forEach((row, index) => {
        row.querySelector('.machine-number').textContent = index + 1;
    });
    machineCounter = rows.length;
    
    // Kosten neu berechnen
    calculateCosts();
}

function updateMachineInfo(select) {
    const row = select.closest('.machine-row');
    const option = select.options[select.selectedIndex];
    const costSheet = option.getAttribute('data-cost-sheet');
    const costPage = option.getAttribute('data-cost-page');
    const costHour = option.getAttribute('data-cost-hour');
    
    let infoText = 'Bitte Maschine ausw√§hlen';
    if (costSheet && costSheet !== 'null') {
        infoText = costSheet + ' ‚Ç¨ pro Bogen';
    } else if (costPage && costPage !== 'null') {
        infoText = costPage + ' ‚Ç¨ pro Seite';
    } else if (costHour) {
        infoText = parseFloat(costHour).toFixed(3) + ' ‚Ç¨ pro Stunde';
    }
    
    row.querySelector('.machine-cost-info').textContent = infoText;
}

// Maschinendaten f√ºr JavaScript verf√ºgbar machen
const machinesData = {
    {% for m in machines %}
    {{ m.id }}: {
        name: "{{ m.name }}",
        type: "{{ m.machine_type }}",
        costPerSheet: {{ m.cost_per_sheet or 'null' }},
        costPerPage: {{ m.depreciation_per_page or 'null' }},
        costPerHour: {{ m.calculate_cost_per_hour() or 'null' }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
};

function updateCalculationFields() {
    const mode = document.getElementById('calculation_mode').value;
    const unitsPerSheetGroup = document.getElementById('units_per_sheet_group');
    const unitsPerBatchGroup = document.getElementById('units_per_batch_group');
    const unitsPerSheetInput = document.getElementById('units_per_sheet');
    const unitsPerBatchInput = document.getElementById('units_per_batch');
    
    if (mode === 'per_batch') {
        unitsPerSheetGroup.style.display = 'none';
        unitsPerSheetInput.required = false;
        unitsPerBatchGroup.style.display = 'block';
        unitsPerBatchInput.required = true;
    } else {
        unitsPerSheetGroup.style.display = 'block';
        unitsPerSheetInput.required = true;
        unitsPerBatchGroup.style.display = 'none';
        unitsPerBatchInput.required = false;
    }
}

// Initialisierung
updateCalculationFields();

// Erste Maschine automatisch hinzuf√ºgen (f√ºr neue Produkte)
{% if not product %}
addMachineRow();
{% endif %}

// Event Listener f√ºr Kostenberechnung
document.getElementById('sheet_material_id').addEventListener('change', calculateCosts);
document.getElementById('units_per_sheet').addEventListener('input', calculateCosts);
document.getElementById('units_per_batch').addEventListener('input', calculateCosts);
document.getElementById('calculation_mode').addEventListener('change', calculateCosts);
document.getElementById('labor_minutes').addEventListener('input', calculateCosts);
document.getElementById('labor_rate_per_hour').addEventListener('input', calculateCosts);

// Materialpreise f√ºr JavaScript verf√ºgbar machen
const materialPrices = {
    {% for s in sticker_sheets %}
    {{ s.id }}: {{ s.price_per_unit or 0 }}{% if not loop.last %},{% endif %}
    {% endfor %}
};

function calculateCosts() {
    const materialSelect = document.getElementById('sheet_material_id');
    const materialId = materialSelect.value;
    const materialPrice = materialPrices[materialId] || 0;
    
    const mode = document.getElementById('calculation_mode').value;
    let unitsPerMaterial = 1;
    
    if (mode === 'per_unit') {
        unitsPerMaterial = parseFloat(document.getElementById('units_per_sheet').value) || 1;
    } else {
        unitsPerMaterial = parseInt(document.getElementById('units_per_batch').value) || 1;
    }
    
    // Materialkosten pro Sticker-Sheet
    const materialCostPerUnit = unitsPerMaterial > 0 ? materialPrice / unitsPerMaterial : materialPrice;
    
    // Maschinenkosten berechnen
    let machinesCost = 0;
    document.querySelectorAll('.machine-row').forEach(row => {
        const select = row.querySelector('.machine-select');
        if (select.value) {
            const option = select.options[select.selectedIndex];
            const costSheet = parseFloat(option.getAttribute('data-cost-sheet')) || 0;
            const costPage = parseFloat(option.getAttribute('data-cost-page')) || 0;
            const costHour = parseFloat(option.getAttribute('data-cost-hour')) || 0;
            
            // F√ºr Sticker-Sheets nehmen wir an: 1 Bogen pro Sheet
            if (costSheet) {
                machinesCost += costSheet;
            } else if (costPage) {
                machinesCost += costPage; // Annahme: 1 Seite pro Sheet
            } else if (costHour) {
                // Zeitbasiert - hier vereinfacht angenommen: 1/60 Stunde pro Sheet
                machinesCost += costHour / 60;
            }
        }
    });
    
    // Arbeitskosten
    const laborMinutes = parseFloat(document.getElementById('labor_minutes').value) || 0;
    const laborRate = parseFloat(document.getElementById('labor_rate_per_hour').value) || 20;
    const laborHours = laborMinutes / 60;
    const laborCost = laborHours * laborRate;
    
    // Gesamtkosten
    const totalCost = materialCostPerUnit + machinesCost + laborCost;
    
    // Anzeigen aktualisieren
    document.getElementById('cost-material').textContent = materialCostPerUnit.toFixed(2) + ' ‚Ç¨';
    document.getElementById('cost-machines').textContent = machinesCost.toFixed(2) + ' ‚Ç¨';
    document.getElementById('cost-labor').textContent = laborCost.toFixed(2) + ' ‚Ç¨';
    document.getElementById('cost-total').textContent = totalCost.toFixed(2) + ' ‚Ç¨';
}

// Auch bei Maschinen√§nderungen Kosten neu berechnen
const originalUpdateMachineInfo = updateMachineInfo;
updateMachineInfo = function(select) {
    originalUpdateMachineInfo(select);
    calculateCosts();
};
</script>

{% endblock %}


