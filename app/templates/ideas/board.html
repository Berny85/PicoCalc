{% extends "base.html" %}

{% block title %}Ideen-Board - Picobellu Kalkulator{% endblock %}

{% block extra_css %}
<style>
    /* Drag & Drop Styles */
    .kanban-card.sortable-ghost {
        opacity: 0.4;
        background: #e0e0e0;
        border: 2px dashed #999;
    }
    
    .kanban-card.sortable-drag {
        opacity: 0.9;
        transform: rotate(3deg);
        box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        cursor: grabbing;
    }
    
    .kanban-column.drag-over {
        background: rgba(102, 126, 234, 0.1);
        border: 2px dashed var(--color-primary);
    }
    
    .kanban-column {
        transition: background-color 0.2s, border 0.2s;
        border: 2px solid transparent;
    }
    
    .kanban-card {
        cursor: grab;
    }
    
    .kanban-card:active {
        cursor: grabbing;
    }
    
    .status-update-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--color-success);
        color: white;
        padding: 12px 24px;
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        display: none;
        z-index: 2000;
        animation: slideIn 0.3s ease;
    }
    
    .status-update-indicator.show {
        display: block;
    }
    
    .status-update-indicator.error {
        background: var(--color-btn-danger);
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    .kanban-board {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-top: 20px;
    }
    
    .kanban-column {
        background: var(--color-bg-hover);
        border-radius: 8px;
        padding: 15px;
        min-height: 400px;
    }
    
    .kanban-column-header {
        font-weight: 600;
        font-size: 1.1rem;
        padding: 10px;
        border-radius: 6px;
        margin-bottom: 15px;
        text-align: center;
    }
    
    .kanban-column-header.todo {
        background: #e3f2fd;
        color: #1976d2;
    }
    
    .kanban-column-header.in_progress {
        background: #fff3e0;
        color: #f57c00;
    }
    
    .kanban-column-header.done {
        background: #e8f5e9;
        color: #388e3c;
    }
    
    .kanban-card {
        background: white;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .kanban-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .kanban-card-subject {
        font-weight: 600;
        color: var(--color-text);
        margin-bottom: 8px;
        font-size: 0.95rem;
    }
    
    .kanban-card-content {
        color: var(--color-text-light);
        font-size: 0.9rem;
        line-height: 1.4;
        white-space: pre-wrap;
        margin-bottom: 10px;
    }
    
    .kanban-card-date {
        font-size: 0.75rem;
        color: var(--color-text-lighter);
    }
    
    .kanban-card-actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid var(--color-border);
    }
    
    .kanban-card-actions .btn-small {
        padding: 4px 10px;
        font-size: 0.8rem;
    }
    
    .idea-form {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .status-selector {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }
    
    .status-btn {
        flex: 1;
        padding: 8px;
        border: 2px solid var(--color-border);
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.2s;
    }
    
    .status-btn.active {
        border-color: var(--color-primary);
        background: rgba(102, 126, 234, 0.1);
    }
    
    .status-btn.todo:hover, .status-btn.todo.active {
        border-color: #1976d2;
        background: #e3f2fd;
    }
    
    .status-btn.in_progress:hover, .status-btn.in_progress.active {
        border-color: #f57c00;
        background: #fff3e0;
    }
    
    .status-btn.done:hover, .status-btn.done.active {
        border-color: #388e3c;
        background: #e8f5e9;
    }
    
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    
    .modal.active {
        display: flex;
    }
    
    .modal-content {
        background: white;
        padding: 25px;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .modal-header h3 {
        margin: 0;
        color: var(--color-primary-dark);
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--color-text-light);
    }
    
    @media (max-width: 768px) {
        .kanban-board {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h2>üí° Ideen-Board</h2>
    <p style="color: var(--color-text-light);">Schnell Ideen notieren und im Kanban-Stil organisieren</p>
</div>

<!-- Neue Idee Formular -->
<div class="idea-form">
    <h3 style="margin-bottom: 15px; color: var(--color-primary-dark);">Neue Idee</h3>
    <form action="/ideas" method="post">
        <div class="form-group">
            <label for="subject">Betreff (optional)</label>
            <input type="text" id="subject" name="subject" placeholder="Kurze √úberschrift...">
        </div>
        <div class="form-group">
            <label for="content">Idee *</label>
            <textarea id="content" name="content" rows="3" placeholder="Beschreibe deine Idee..." required></textarea>
        </div>
        <div class="form-group">
            <label>Status</label>
            <div class="status-selector">
                <button type="button" class="status-btn todo active" onclick="selectStatus('todo')">üìã Todo</button>
                <button type="button" class="status-btn in_progress" onclick="selectStatus('in_progress')">‚ö° In Arbeit</button>
                <button type="button" class="status-btn done" onclick="selectStatus('done')">‚úÖ Erledigt</button>
            </div>
            <input type="hidden" name="status" id="status_input" value="todo">
        </div>
        <button type="submit" class="btn btn-primary">üí° Idee speichern</button>
    </form>
</div>

<!-- Kanban Board -->
<div class="kanban-board">
    <!-- Todo Column -->
    <div class="kanban-column" data-status="todo">
        <div class="kanban-column-header todo">
            üìã Todo (<span class="column-count">{{ ideas_todo|length }}</span>)
        </div>
        {% for idea in ideas_todo %}
        <div class="kanban-card" data-id="{{ idea.id }}" data-subject="{{ idea.subject|default('')|escape }}" data-content="{{ idea.content|escape }}" data-status="{{ idea.status }}">
            {% if idea.subject %}
            <div class="kanban-card-subject">{{ idea.subject }}</div>
            {% endif %}
            <div class="kanban-card-content">{{ idea.content }}</div>
            <div class="kanban-card-date">{{ idea.created_at.strftime('%d.%m.%Y %H:%M') }}</div>
        </div>
        {% endfor %}
    </div>
    
    <!-- In Progress Column -->
    <div class="kanban-column" data-status="in_progress">
        <div class="kanban-column-header in_progress">
            ‚ö° In Arbeit (<span class="column-count">{{ ideas_in_progress|length }}</span>)
        </div>
        {% for idea in ideas_in_progress %}
        <div class="kanban-card" data-id="{{ idea.id }}" data-subject="{{ idea.subject|default('')|escape }}" data-content="{{ idea.content|escape }}" data-status="{{ idea.status }}">
            {% if idea.subject %}
            <div class="kanban-card-subject">{{ idea.subject }}</div>
            {% endif %}
            <div class="kanban-card-content">{{ idea.content }}</div>
            <div class="kanban-card-date">{{ idea.created_at.strftime('%d.%m.%Y %H:%M') }}</div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Done Column -->
    <div class="kanban-column" data-status="done">
        <div class="kanban-column-header done">
            ‚úÖ Erledigt (<span class="column-count">{{ ideas_done|length }}</span>)
        </div>
        {% for idea in ideas_done %}
        <div class="kanban-card" data-id="{{ idea.id }}" data-subject="{{ idea.subject|default('')|escape }}" data-content="{{ idea.content|escape }}" data-status="{{ idea.status }}">
            {% if idea.subject %}
            <div class="kanban-card-subject">{{ idea.subject }}</div>
            {% endif %}
            <div class="kanban-card-content">{{ idea.content }}</div>
            <div class="kanban-card-date">{{ idea.created_at.strftime('%d.%m.%Y %H:%M') }}</div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Status Update Indicator -->
<div id="statusIndicator" class="status-update-indicator">
    ‚úÖ Status aktualisiert
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚úèÔ∏è Idee bearbeiten</h3>
            <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <form id="editForm" action="" method="post">
            <div class="form-group">
                <label for="edit_subject">Betreff (optional)</label>
                <input type="text" id="edit_subject" name="subject" placeholder="Kurze √úberschrift...">
            </div>
            <div class="form-group">
                <label for="edit_content">Idee *</label>
                <textarea id="edit_content" name="content" rows="5" placeholder="Beschreibe deine Idee..." required></textarea>
            </div>
            <div class="form-group">
                <label>Status</label>
                <div class="status-selector">
                    <button type="button" class="status-btn todo" id="btn_todo" onclick="selectEditStatus('todo')">üìã Todo</button>
                    <button type="button" class="status-btn in_progress" id="btn_in_progress" onclick="selectEditStatus('in_progress')">‚ö° In Arbeit</button>
                    <button type="button" class="status-btn done" id="btn_done" onclick="selectEditStatus('done')">‚úÖ Erledigt</button>
                </div>
                <input type="hidden" name="status" id="edit_status_input" value="todo">
            </div>
            <div class="actions">
                <button type="submit" class="btn btn-primary">üíæ Speichern</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Abbrechen</button>
                <button type="button" class="btn btn-danger" onclick="deleteIdea()" style="margin-left: auto;">üóëÔ∏è L√∂schen</button>
            </div>
        </form>
        <form id="deleteForm" action="" method="post" style="display: none;">
            <input type="hidden" name="_method" value="delete">
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- SortableJS f√ºr Drag & Drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
    // Drag & Drop Initialisierung
    document.addEventListener('DOMContentLoaded', function() {
        const columns = document.querySelectorAll('.kanban-column');
        
        columns.forEach(column => {
            new Sortable(column, {
                group: 'kanban', // Erlaubt Drag zwischen Spalten
                animation: 150,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                delay: 0,
                delayOnTouchOnly: true,
                touchStartThreshold: 5,
                onStart: function(evt) {
                    evt.from.classList.add('drag-over');
                },
                onEnd: function(evt) {
                    // Visuals entfernen
                    columns.forEach(col => col.classList.remove('drag-over'));
                    
                    // Nur wenn sich die Spalte ge√§ndert hat
                    if (evt.from !== evt.to) {
                        const ideaId = evt.item.getAttribute('data-id');
                        const newStatus = evt.to.getAttribute('data-status');
                        const oldStatus = evt.from.getAttribute('data-status');
                        
                        // Status via AJAX aktualisieren
                        updateIdeaStatus(ideaId, newStatus, evt.item, evt.from, evt.to);
                    }
                },
                onAdd: function(evt) {
                    // Wird aufgerufen wenn Element in neue Spalte kommt
                    updateColumnCounts();
                },
                onRemove: function(evt) {
                    // Wird aufgerufen wenn Element aus Spalte entfernt wird
                    updateColumnCounts();
                }
            });
        });
    });
    
    // Status per AJAX aktualisieren
    function updateIdeaStatus(ideaId, newStatus, cardElement, fromColumn, toColumn) {
        const formData = new FormData();
        formData.append('status', newStatus);
        
        fetch(`/ideas/${ideaId}/status`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Status-Update fehlgeschlagen');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showStatusIndicator('‚úÖ Status aktualisiert', false);
                // Update onclick handler mit neuem Status
                updateCardOnclick(cardElement, newStatus);
            } else {
                throw new Error('Update nicht erfolgreich');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showStatusIndicator('‚ùå Fehler beim Speichern', true);
            // R√ºckg√§ngig: Karte zur√ºck in alte Spalte
            fromColumn.appendChild(cardElement);
            updateColumnCounts();
        });
    }
    
    // Onclick-Handler der Karte aktualisieren
    function updateCardOnclick(cardElement, newStatus) {
        // data-status Attribut aktualisieren
        cardElement.setAttribute('data-status', newStatus);
    }
    
    // Klick-Event f√ºr alle Kanban-Karten (Event Delegation)
    document.querySelectorAll('.kanban-column').forEach(column => {
        column.addEventListener('click', function(e) {
            const card = e.target.closest('.kanban-card');
            if (!card) return;
            
            // Pr√ºfen ob gerade gedraggt wird
            if (card.classList.contains('sortable-drag')) return;
            
            const id = card.getAttribute('data-id');
            const subject = card.getAttribute('data-subject') || '';
            const content = card.getAttribute('data-content') || '';
            const status = card.getAttribute('data-status');
            
            openEditModal(parseInt(id), subject, content, status);
        });
    });
    
    // Spalten-Z√§hler aktualisieren
    function updateColumnCounts() {
        document.querySelectorAll('.kanban-column').forEach(column => {
            const count = column.querySelectorAll('.kanban-card').length;
            const countElement = column.querySelector('.column-count');
            if (countElement) {
                countElement.textContent = count;
            }
        });
    }
    
    // Status-Indikator anzeigen
    function showStatusIndicator(message, isError) {
        const indicator = document.getElementById('statusIndicator');
        indicator.textContent = message;
        indicator.classList.toggle('error', isError);
        indicator.classList.add('show');
        
        setTimeout(() => {
            indicator.classList.remove('show');
        }, 2500);
    }
    
    function selectStatus(status) {
        document.querySelectorAll('.status-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector('.status-btn.' + status).classList.add('active');
        document.getElementById('status_input').value = status;
    }
    
    function selectEditStatus(status) {
        document.querySelectorAll('#editForm .status-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById('btn_' + status).classList.add('active');
        document.getElementById('edit_status_input').value = status;
    }
    
    let currentIdeaId = null;
    
    function openEditModal(id, subject, content, status) {
        currentIdeaId = id;
        document.getElementById('editForm').action = '/ideas/' + id + '/update';
        document.getElementById('deleteForm').action = '/ideas/' + id + '/delete';
        document.getElementById('edit_subject').value = subject;
        document.getElementById('edit_content').value = content;
        selectEditStatus(status);
        document.getElementById('editModal').classList.add('active');
    }
    
    function closeEditModal() {
        document.getElementById('editModal').classList.remove('active');
        currentIdeaId = null;
    }
    
    function deleteIdea() {
        if (confirm('M√∂chtest du diese Idee wirklich l√∂schen?')) {
            document.getElementById('deleteForm').submit();
        }
    }
    
    // Close modal when clicking outside
    document.getElementById('editModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeEditModal();
        }
    });
    
    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeEditModal();
        }
    });
</script>
{% endblock %}
